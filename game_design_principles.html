<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional & Non-functional Arcade Game Requirements</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #FFC107; /* Amber */
            --background-color: #121212; /* Dark background */
            --light-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --arcade-font: 'Press Start 2P', cursive;
            --instruction-color: #82aaff; /* A clear, readable blue */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        
        /* Animated background */
        .stars {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            display: block;
            z-index: -1;
        }
        .star {
            position: absolute;
            width: 2px; height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(22, 27, 34, 0.9);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
        }

        h1, h2, h3, h4 {
            font-family: var(--arcade-font);
            color: var(--primary-color);
            text-shadow: 2px 2px #000;
        }
        
        h1 { font-size: 1.8em; text-align: center; margin-bottom: 20px;}
        h2 { font-size: 1.4em; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px;}
        h3 { font-size: 1.1em; color: var(--secondary-color); margin-top: 20px;}
        h4 { font-size: 1em; color: var(--primary-color);}
        
        .instruction-box {
            background-color: rgba(74, 144, 226, 0.1);
            border-left: 4px solid var(--instruction-color);
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        .instruction-box p {
            margin: 0;
            font-weight: bold;
            color: var(--instruction-color); /* Updated color for instructions */
        }


        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .nav-tab {
            padding: 10px 15px;
            background: #333;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-color);
            font-weight: bold;
        }
        .nav-tab.active, .nav-tab:hover {
            background: var(--primary-color);
            color: white;
            border-color: #fff;
            transform: scale(1.05);
        }

        /* Content Sections */
        .section {
            display: none;
            padding: 20px;
            background: #222;
            border-radius: 10px;
            border: 1px solid #444;
            animation: fadeIn 0.5s;
        }
        .section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Timer Styling */
        .floating-timer {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--light-bg);
            color: var(--primary-color);
            font-family: var(--arcade-font);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1000;
            user-select: none;
        }
        .floating-timer.paused {
            color: #888;
            border-color: #555;
        }
        .floating-timer.finished {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Form elements */
        textarea, input[type="text"], select {
            width: 100%;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: var(--text-color);
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            margin-top: 5px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            transform: scale(1.5);
            margin: 0;
        }

        /* Buttons */
        .btn {
            font-family: var(--arcade-font);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .btn-primary { background-color: var(--primary-color); color: white; border: 2px solid #fff; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .btn:disabled { background: #555; color: #999; cursor: not-allowed; transform: none; border: 2px solid #777; }
        
        .download-button-container {
            text-align: center;
            margin-top: 30px;
            border-top: 1px dashed #444;
            padding-top: 20px;
        }
        
        /* Specific Activity Styles */
        .entry-ticket, .quiz-container, .game-container-wrapper, .collab-section, .journal {
             background: #2a2a2a; padding: 20px; border-radius: 10px; margin-top:20px;
        }
         .requirements-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .requirements-table th, .requirements-table td {
            padding: 12px;
            border: 1px solid #30363d;
            text-align: left;
        }
         .requirements-table th { background: #21262d; }
         .quiz-option, .quiz-options .quiz-option {
            display: block; margin: 10px 0; padding: 10px; background: #333;
            border: 2px solid #555; border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .quiz-option.selected, .quiz-option:hover {
            border-color: var(--primary-color);
            background-color: #3e5064;
        }
        #gameAnalysis { margin-top: 30px; }
        #gameAnalysis input { margin-bottom: 10px; }
        .peer-review { margin-top: 15px; }
        .review-item { display: flex; align-items: center; margin-bottom: 10px; }
        .review-checkbox { width: auto; margin-right: 10px; }

        .drag-drop-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .drop-zone {
            min-height: 150px;
            padding: 15px;
            border: 2px dashed #444;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .drop-zone.drag-over { background-color: #333; }
        .draggable-item {
            padding: 10px;
            margin: 5px 0;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: grab;
        }
        .draggable-item.correct { border-left: 5px solid #4caf50; }
        .draggable-item.incorrect { border-left: 5px solid #f44336; }
        .dragging { opacity: 0.5; }

        .game-container {
            background: #000;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        #gameCanvas {
            background: #000;
            border: 2px solid var(--primary-color);
            max-width: 100%;
        }
        .game-controls button { margin: 5px; }

        .feedback {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
            color: white;
            font-weight: bold;
        }
        .feedback.success { background-color: #2e7d32; }
        .feedback.error { background-color: #b71c1c; }
        .feedback.info { background-color: #1565c0; }
    </style>
</head>
<body>
    <div class="stars"></div>

    <div class="container" id="main-content">
        <header class="header">
            <h1>üéÆ Functional & Non-functional Requirements</h1>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" data-section-id="section1">1. Entry Ticket</button>
            <button class="nav-tab" data-section-id="section2">2. Concepts</button>
            <button class="nav-tab" data-section-id="section3">3. Play & Analyse</button>
            <button class="nav-tab" data-section-id="section4">4. Apply Knowledge</button>
            <button class="nav-tab" data-section-id="section5">5. Collaborate</button>
            <button class="nav-tab" data-section-id="section6">6. Reflect</button>
        </div>

        <!-- Section 1: Entry Ticket -->
        <section class="section active" id="section1">
            <h2>Entry Ticket - Test Your Prior Knowledge</h2>
            <div class="instruction-box">
                <p><strong>Instructions:</strong> Answer the two questions below based on what you already know. There are no wrong answers! This is to see what you think before we start the lesson.</p>
            </div>
            <div class="entry-ticket">
                <p><strong>Learning Intention:</strong> We will explore how games have functional and non-functional requirements.</p>
                <p><strong>Success Criteria:</strong> You will be able to explain the functional and non-functional requirements of a game.</p>
                <div style="margin-top: 20px;">
                    <label for="priorKnowledge1"><strong>What are Functional and Non-functional requirements?</strong></label>
                    <textarea class="ticket-input" id="priorKnowledge1" rows="4" placeholder="Type your answer here... Think about what a system MUST DO vs HOW it does it..."></textarea>
                </div>
                <div style="margin-top: 20px;">
                    <label for="priorKnowledge2"><strong>How can this be related to a game that you know?</strong></label>
                    <textarea class="ticket-input" id="priorKnowledge2" rows="4" placeholder="Think of your favourite game... What must it do? How should it perform?"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitEntryTicket()">Submit Entry Ticket üöÄ</button>
                <div class="feedback" id="entryFeedback"></div>
            </div>
             <div class="download-button-container">
                <button class="btn btn-primary" onclick="downloadSectionAsPDF('section1', this)">Save Entry Ticket as PDF</button>
            </div>
        </section>

        <!-- Section 2: Learn the Concepts -->
        <section class="section" id="section2">
            <h2>Understanding Requirements</h2>
            <div class="instruction-box">
                 <p><strong>Instructions:</strong> First, watch the short video below. Then, drag each of the requirement cards from the box into either the 'Functional' or 'Non-functional' category. Click 'Check My Sorting' when you are done.</p>
            </div>
             <!-- YouTube Video Embed Start -->
            <div class="quiz-container">
                <h3>üé• Watch & Learn</h3>
                <p>This video explains the difference between functional and non-functional requirements.</p>
                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 8px; margin: 20px 0;">
                    <iframe 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                        src="https://www.youtube.com/embed/5_n8t0_92tI" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
            <!-- YouTube Video Embed End -->
            <div id="requirementsToSort" style="background: var(--light-bg); padding: 20px; border-radius: 10px; margin: 20px 0; min-height: 50px;">
                <div class="draggable-item" draggable="true" id="drag1" data-type="functional">Player can move left and right</div>
                <div class="draggable-item" draggable="true" id="drag2" data-type="non-functional">Game runs at 60 FPS</div>
                <div class="draggable-item" draggable="true" id="drag3" data-type="functional">Score increases when enemy is destroyed</div>
                <div class="draggable-item" draggable="true" id="drag4" data-type="non-functional">Appealing retro graphics</div>
                <div class="draggable-item" draggable="true" id="drag5" data-type="functional">Game ends when player loses all lives</div>
                <div class="draggable-item" draggable="true" id="drag6" data-type="non-functional">Easy to learn, hard to master</div>
            </div>
            <div class="drag-drop-container">
                <div class="drop-zone" id="functionalDrop" data-type="functional"><h3>‚úÖ Functional Requirements</h3><p style="color: #888;">(WHAT the game does)</p></div>
                <div class="drop-zone" id="nonFunctionalDrop" data-type="non-functional"><h3>üé® Non-functional Requirements</h3><p style="color: #888;">(HOW it does it)</p></div>
            </div>
            <button class="btn btn-primary" onclick="checkSorting()">Check My Sorting ‚úîÔ∏è</button>
            <div class="feedback" id="sortingFeedback"></div>
            <div class="download-button-container">
                <button class="btn btn-primary" onclick="downloadSectionAsPDF('section2', this)">Save Sorting Activity as PDF</button>
            </div>
        </section>

        <!-- Section 3: Space Invaders Analysis -->
        <section class="section" id="section3">
            <h2>Space Invaders - A Classic Case Study</h2>
             <div class="instruction-box">
                <p><strong>Instructions:</strong> Play the mini Space Invaders game below. Then, fill out the tables to analyze its functional requirements (what it does) and rate its non-functional requirements (how well it does it).</p>
            </div>
            <div class="game-container">
                 <h3 style="color: #00ff00; text-align: center; font-family: var(--arcade-font);">üöÄ SPACE INVADERS MINI üöÄ</h3>
                 <canvas id="gameCanvas" width="600" height="400"></canvas>
                 <div class="game-controls">
                     <button class="btn btn-primary" onclick="startGame()">Start Game</button>
                     <button class="btn btn-primary" onclick="pauseGame()">Pause/Resume</button>
                     <button class="btn btn-primary" onclick="resetGame()">Reset</button>
                 </div>
                 <p style="color: #00ff00; text-align: center; margin-top: 10px;">Use ‚Üê ‚Üí arrow keys to move | SPACE to shoot</p>
            </div>
            <h3>üìã Functional Requirements Analysis</h3>
            <table class="requirements-table">
                <thead><tr><th>Test Case</th><th>Expected Behaviour</th><th>‚úì Verified</th></tr></thead>
                <tbody>
                    <tr><td>Player presses left, right keys</td><td><input type="text" class="table-input" id="func2" placeholder="e.g., The player's ship moves horizontally."></td><td style="text-align: center;"><input type="checkbox" id="funcCheck2"></td></tr>
                    <tr><td>Player presses space bar</td><td><input type="text" class="table-input" id="func3" placeholder="e.g., A laser shoots from the ship."></td><td style="text-align: center;"><input type="checkbox" id="funcCheck3"></td></tr>
                    <tr><td>Laser hits an invader</td><td><input type="text" class="table-input" id="func4" placeholder="e.g., The invader disappears and score increases."></td><td style="text-align: center;"><input type="checkbox" id="funcCheck4"></td></tr>
                    <tr><td>Invaders reach the bottom</td><td><input type="text" class="table-input" id="func5" placeholder="e.g., The game is over."></td><td style="text-align: center;"><input type="checkbox" id="funcCheck5"></td></tr>
                </tbody>
            </table>
            <h3>üåü Non-functional Requirements Rating</h3>
            <table class="requirements-table">
                <thead><tr><th>Requirement</th><th>Rating (1-5 ‚≠ê)</th><th>Your Justification</th></tr></thead>
                <tbody>
                    <tr><td>Usability (Easy to learn)</td><td><select class="table-input" id="nf1"><option value="">Select...</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td><td><input type="text" class="table-input" placeholder="e.g., Simple controls make it easy to start."></td></tr>
                    <tr><td>Performance (Smoothness)</td><td><select class="table-input" id="nf3"><option value="">Select...</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td><td><input type="text" class="table-input" placeholder="e.g., The game runs without lag."></td></tr>
                    <tr><td>Aesthetics (Visual Appeal)</td><td><select class="table-input" id="nf5"><option value="">Select...</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td><td><input type="text" class="table-input" placeholder="e.g., The pixel art style is iconic."></td></tr>
                </tbody>
            </table>
            <div class="download-button-container">
                <button class="btn btn-primary" onclick="downloadSectionAsPDF('section3', this)">Save Analysis as PDF</button>
            </div>
        </section>

        <!-- Section 4: Apply Your Knowledge -->
        <section class="section" id="section4">
            <h2>Apply Your Knowledge - Design Challenge</h2>
            <div class="instruction-box">
                <p><strong>Instructions:</strong> Choose one of the classic games listed below. Then, write three functional requirements and three non-functional requirements for that game in the text boxes provided.</p>
            </div>
            <div class="quiz-container">
                <h3>üéÆ Your Turn: Choose a Classic Game</h3>
                <div class="quiz-options">
                    <div class="quiz-option" onclick="selectGame(this, 'Pac-Man')"><strong>üëª Pac-Man</strong></div>
                    <div class="quiz-option" onclick="selectGame(this, 'Tetris')"><strong>üß± Tetris</strong></div>
                    <div class="quiz-option" onclick="selectGame(this, 'Pong')"><strong>üèì Pong</strong></div>
                </div>
            </div>
            <div id="gameAnalysis" style="display: none; margin-top: 30px;">
                <h3>üìù Analyse <span id="chosenGameName">Your Chosen Game</span></h3>
                <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>List 3 Functional Requirements:</h4>
                    <ol>
                        <li><input type="text" class="table-input" placeholder="e.g., The player character moves up, down, left, right."></li>
                        <li><input type="text" class="table-input" placeholder="e.g., Collecting a power-up changes ghost behavior."></li>
                        <li><input type="text" class="table-input" placeholder="e.g., The game ends when all lives are lost."></li>
                    </ol>
                </div>
                <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>List 3 Non-functional Requirements:</h4>
                    <ol>
                        <li><input type="text" class="table-input" placeholder="e.g., The controls must be responsive with less than 50ms delay."></li>
                        <li><input type="text" class="table-input" placeholder="e.g., The game must maintain a consistent frame rate of 30 FPS."></li>
                        <li><input type="text" class="table-input" placeholder="e.g., The sound effects should provide clear feedback for actions."></li>
                    </ol>
                </div>
            </div>
            <div class="download-button-container">
                <button class="btn btn-primary" onclick="downloadSectionAsPDF('section4', this)">Save My Design as PDF</button>
            </div>
        </section>

        <!-- Section 5: Collaboration & Peer Review -->
        <section class="section" id="section5">
            <h2>Collaborate & Review</h2>
             <div class="instruction-box">
                <p><strong>Instructions:</strong> After completing the 'Apply Your Knowledge' activity, download it as a PDF and share it with a partner. Then, use the checklist below to review their work and provide them with constructive feedback in the text area.</p>
            </div>
            <div class="collab-section">
                <h3>üë• Peer Review Checklist</h3>
                <div class="peer-review">
                    <div class="review-item"><input type="checkbox" id="peer1"><label for="peer1">Functional requirements clearly describe WHAT the game does.</label></div>
                    <div class="review-item"><input type="checkbox" id="peer2"><label for="peer2">Non-functional requirements clearly describe HOW it performs.</label></div>
                    <div class="review-item"><input type="checkbox" id="peer3"><label for="peer3">Requirements are specific and measurable.</label></div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="peerFeedback"><strong>Feedback for your partner:</strong></label>
                    <textarea id="peerFeedback" rows="5" placeholder="What did they do well? Are their requirements clear and testable? What could be improved?"></textarea>
                </div>
            </div>
            <div class="download-button-container">
                <button class="btn btn-primary" onclick="downloadSectionAsPDF('section5', this)">Save Feedback as PDF</button>
            </div>
        </section>

        <!-- Section 6: Reflection & Achievement -->
        <section class="section" id="section6">
            <h2>Reflection & Achievements</h2>
            <div class="instruction-box">
                <p><strong>Instructions:</strong> Reflect on what you've learned by answering the questions below. This is your chance to think about how these concepts apply to your own projects.</p>
            </div>
            <div class="journal">
                <h3>üí≠ Reflection Journal</h3>
                <label for="reflection1"><strong>What is the most important difference between functional and non-functional requirements?</strong></label>
                <textarea class="journal-entry" id="reflection1" rows="4" placeholder="Think about WHAT vs HOW..."></textarea>
                <label for="reflection2" style="margin-top: 20px; display: block;"><strong>How will understanding requirements help you in your game development project?</strong></label>
                <textarea class="journal-entry" id="reflection2" rows="4" placeholder="Consider planning, testing, and evaluation..."></textarea>
            </div>
             <div class="download-button-container">
                <button class="btn btn-primary" onclick="downloadSectionAsPDF('section6', this)">Save My Reflection as PDF</button>
            </div>
        </section>
    </div>
    
    <div class="floating-timer" id="activityTimer">15:00</div>

    <script>
        // --- Core Page Navigation ---
        let currentSectionId = 'section1';
        
        function showSection(sectionId) {
            currentSectionId = sectionId;
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.sectionId === sectionId);
            });
        }

        // --- PDF Download Functionality (FIXED) ---
        async function downloadSectionAsPDF(sectionId, buttonElement) {
            // Ensure jsPDF and html2canvas are loaded
            if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                console.error("jsPDF or html2canvas library not loaded.");
                alert("Error: PDF generation library is missing.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const sectionElement = document.getElementById(sectionId);
            const sectionTitle = sectionElement.querySelector('h2').innerText;

            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'üì• Generating...';
            buttonElement.disabled = true;

            try {
                const canvas = await html2canvas(sectionElement, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true,
                    logging: false,
                    onclone: (clonedDoc) => {
                        const clonedSection = clonedDoc.querySelector('#' + sectionId);
                        if (!clonedSection) return;

                        // Hide the download button container within the cloned element
                        const buttonContainerInClone = clonedSection.querySelector('.download-button-container');
                        if (buttonContainerInClone) {
                            buttonContainerInClone.style.display = 'none';
                        }

                        // Ensure form values are preserved in the clone
                        const originalElements = sectionElement.querySelectorAll('textarea, input, select');
                        const clonedElements = clonedSection.querySelectorAll('textarea, input, select');

                        originalElements.forEach((el, index) => {
                            if (clonedElements[index]) {
                                const clonedEl = clonedElements[index];
                                if (el.type === 'checkbox' || el.type === 'radio') {
                                    clonedEl.checked = el.checked;
                                } else {
                                    clonedEl.value = el.value;
                                    if(clonedEl.tagName === 'TEXTAREA') {
                                        clonedEl.innerHTML = el.value;
                                    }
                                }
                            }
                        });
                    }
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const ratio = imgProps.width / pdfWidth;
                const imgHeight = imgProps.height / ratio;

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = position - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }

                const safeFileName = sectionTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                pdf.save(`${safeFileName}_activity.pdf`);

            } catch (error) {
                console.error("Error generating PDF:", error);
                buttonElement.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    buttonElement.innerHTML = originalButtonText;
                    buttonElement.disabled = false;
                }, 3000);
            } finally {
                if (!buttonElement.innerHTML.includes('Error')) {
                     buttonElement.innerHTML = originalButtonText;
                     buttonElement.disabled = false;
                }
            }
        }

        // --- Activity Logic ---
        function submitEntryTicket() {
            const feedbackEl = document.getElementById('entryFeedback');
            feedbackEl.textContent = 'Thank you for your thoughts! Your entry has been recorded.';
            feedbackEl.className = 'feedback success';
            feedbackEl.style.display = 'block';
        }

        function selectGame(element, gameName) {
            document.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('chosenGameName').textContent = gameName;
            document.getElementById('gameAnalysis').style.display = 'block';
        }

        function checkSorting() {
            let correctCount = 0;
            const functionalDrop = document.getElementById('functionalDrop');
            const nonFunctionalDrop = document.getElementById('nonFunctionalDrop');
            
            functionalDrop.querySelectorAll('.draggable-item').forEach(item => {
                if (item.dataset.type === 'functional') {
                    item.classList.add('correct');
                    item.classList.remove('incorrect');
                    correctCount++;
                } else {
                    item.classList.add('incorrect');
                    item.classList.remove('correct');
                }
            });

            nonFunctionalDrop.querySelectorAll('.draggable-item').forEach(item => {
                if (item.dataset.type === 'non-functional') {
                    item.classList.add('correct');
                    item.classList.remove('incorrect');
                    correctCount++;
                } else {
                    item.classList.add('incorrect');
                     item.classList.remove('correct');
                }
            });

            const feedbackEl = document.getElementById('sortingFeedback');
            if (correctCount === 6) {
                feedbackEl.textContent = 'Perfect sorting! You\'ve nailed the concepts!';
                feedbackEl.className = 'feedback success';
            } else {
                feedbackEl.textContent = `You got ${correctCount} out of 6 correct. Review the incorrect items (marked in red) and try again!`;
                feedbackEl.className = 'feedback info';
            }
            feedbackEl.style.display = 'block';
        }


        // --- Page Setup and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Starry background
            const starsContainer = document.querySelector('.stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                starsContainer.appendChild(star);
            }

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => showSection(tab.dataset.sectionId));
            });

            // Timer
            const timerElement = document.getElementById('activityTimer');
            let time = 900; // 15 minutes
            setInterval(() => {
                if (time > 0) {
                    time--;
                    const minutes = Math.floor(time / 60).toString().padStart(2, '0');
                    const seconds = (time % 60).toString().padStart(2, '0');
                    timerElement.textContent = `${minutes}:${seconds}`;
                } else {
                    timerElement.classList.add('finished');
                }
            }, 1000);

            // Drag and Drop Logic
            const draggables = document.querySelectorAll('.draggable-item');
            const dropZones = document.querySelectorAll('.drop-zone');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => {
                    draggable.classList.add('dragging');
                });
                draggable.addEventListener('dragend', () => {
                    draggable.classList.remove('dragging');
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const draggable = document.querySelector('.dragging');
                    if (draggable) {
                        zone.appendChild(draggable);
                    }
                });
            });
        });

        // --- Space Invaders Game Logic ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let player, invaders, bullets, keys, score, gameOver, gameRunning, gamePaused;

        function initGame() {
            player = { x: canvas.width / 2 - 20, y: canvas.height - 40, width: 40, height: 20, speed: 5 };
            bullets = [];
            invaders = [];
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 8; j++) {
                    invaders.push({ x: 50 + j * 60, y: 30 + i * 40, width: 40, height: 20, alive: true });
                }
            }
            keys = {};
            score = 0;
            gameOver = false;
            gameRunning = false;
            gamePaused = false;
            draw();
        }

        function startGame() { if (!gameRunning) { gameRunning = true; gameLoop(); } }
        function pauseGame() { if(gameRunning) gamePaused = !gamePaused; }
        function resetGame() { initGame(); }
        
        document.addEventListener('keydown', e => keys[e.code] = true);
        document.addEventListener('keyup', e => keys[e.code] = false);

        function update() {
            if (gameOver || !gameRunning || gamePaused) return;

            // Player movement
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;

            // Player shooting
            if (keys['Space']) {
                if (!keys.fired) {
                    bullets.push({ x: player.x + player.width / 2 - 2.5, y: player.y, width: 5, height: 10, speed: 7 });
                    keys.fired = true;
                }
            } else {
                keys.fired = false;
            }

            // Update bullets
            bullets.forEach((bullet, index) => {
                bullet.y -= bullet.speed;
                if (bullet.y < 0) bullets.splice(index, 1);

                // Collision with invaders
                invaders.forEach(invader => {
                    if (invader.alive && bullet.x < invader.x + invader.width && bullet.x + bullet.width > invader.x &&
                        bullet.y < invader.y + invader.height && bullet.y + bullet.height > invader.y) {
                        invader.alive = false;
                        bullets.splice(index, 1);
                        score += 10;
                    }
                });
            });

            // Update invaders
             let moveDown = false;
             invaders.forEach(invader => {
                if (invader.alive) {
                    // Simple back and forth movement placeholder
                    if (Math.random() < 0.001) invader.y += 5; 
                    if (invader.y + invader.height >= canvas.height) gameOver = true;
                }
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'lime';
            ctx.fillRect(player.x, player.y, player.width, player.height);

            bullets.forEach(bullet => {
                ctx.fillStyle = 'yellow';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });

            invaders.forEach(invader => {
                if (invader.alive) {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(invader.x, invader.y, invader.width, invader.height);
                }
            });

            ctx.fillStyle = 'white';
            ctx.font = "20px 'Press Start 2P'";
            ctx.fillText(`Score: ${score}`, 10, 25);
            
            if (gameOver) {
                ctx.fillStyle = 'orange';
                ctx.textAlign = 'center';
                ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2);
            }
             if (gamePaused && !gameOver) {
                ctx.fillStyle = 'orange';
                ctx.textAlign = 'center';
                ctx.fillText("PAUSED", canvas.width / 2, canvas.height / 2);
            }
        }

        function gameLoop() {
            update();
            draw();
            if (gameRunning) {
                requestAnimationFrame(gameLoop);
            }
        }
        
        initGame(); // Initialize game on load

    </script>
</body>
</html>
